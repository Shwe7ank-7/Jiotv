<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JioTV HD Player</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  
  <style>
    body { background: #000; height: 100vh; width: 100vw; margin: 0; overflow: hidden; font-family: sans-serif; }
    .shaka-video-container { width: 100%; height: 100%; }
    video { width: 100%; height: 100%; object-fit: contain; }
    
    /* White UI Theme */
    .shaka-overflow-menu, .shaka-settings-menu {
      background-color: white !important;
      color: black !important;
      border-radius: 8px;
    }
    .shaka-overflow-menu button, .shaka-settings-menu button {
      color: black !important;
    }
    .shaka-overflow-menu button:hover, .shaka-settings-menu button:hover {
      background-color: #eee !important;
    }
    .shaka-controls-button-panel .material-icons-round {
      color: white !important;
    }
    
    /* Overlays */
    .back-btn {
      position: absolute; top: 20px; left: 20px; z-index: 99;
      background: rgba(0,0,0,0.5); color: white; padding: 8px 16px;
      border-radius: 20px; text-decoration: none; border: 1px solid rgba(255,255,255,0.2);
    }
    #status {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 16px; background: rgba(0,0,0,0.8);
      padding: 15px 25px; border-radius: 30px; z-index: 50;
    }
  </style>
</head>
<body>

  <a href="index.html" class="back-btn">‚Üê Back</a>
  <div id="status">Loading Stream...</div>

  <div class="shaka-video-container" data-shaka-player>
    <video autoplay playsinline></video>
  </div>

  <script>
    // --- 1. MANUAL KEY DATABASE (The Fix) ---
    // If a channel fails or is low quality, add its specific key here.
    // Format: "Channel_Name_In_M3U": { "key_id": "key" }
    const STATIC_KEYS = {
      "Sports18_1_HD_BTS": { 
        "bd1ea6a1c1fb5dcdb709434e0826bbc0": "f57f22cba32739ce7beb1fab3f3d060b" 
      },
      // Add Star Sports keys here if you find them:
      // "Star_Sports_2_Hindi_HD": { "key_id": "key" }
    };

    const WORKER_URL = "https://pkll.xojiv79335.workers.dev/"; 
    const M3U_URL = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";

    document.addEventListener('DOMContentLoaded', async () => {
      const status = document.getElementById('status');
      const urlParams = new URLSearchParams(window.location.search);
      const targetId = urlParams.get('id');

      if (!targetId) { status.innerText = "Error: No ID"; return; }

      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) { status.innerText = "Browser Not Supported"; return; }

      const video = document.querySelector('video');
      const player = new shaka.Player(video);
      const ui = new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);

      ui.configure({
        controlPanelElements: ['play_pause', 'time_and_duration', 'mute', 'volume', 'spacer', 'quality', 'fullscreen', 'overflow_menu'],
        seekBarColors: { base: 'rgba(255,255,255,0.3)', buffered: 'rgba(255,255,255,0.54)', played: 'red' }
      });

      // --- 2. SMART FINDER ---
      let streamUrl = "";
      let cookieHeader = "";
      let drmConfig = {};
      let channelNameInternal = "";

      try {
        status.innerText = "Scanning Playlist...";
        const res = await fetch(M3U_URL);
        const text = await res.text();
        const lines = text.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes(`tvg-id="${targetId}"`)) {
            
            // Try to find internal name for Static Key lookup
            const logoLine = lines[i]; 
            // Often the internal name is part of the logo url or name
            
            for (let j = i + 1; j < lines.length; j++) {
              const line = lines[j].trim();
              
              if (line.startsWith('#EXTHTTP:')) {
                const match = line.match(/"cookie":"([^"]+)"/);
                if (match) cookieHeader = match[1];
              } 
              else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                const parts = line.split('license_key=')[1].split(':');
                if (parts.length >= 2) drmConfig = { clearKeys: { [parts[0]]: parts[1] } };
              }
              else if (line.startsWith('http')) {
                streamUrl = line;
                // Hack: extract internal name from URL for static key lookup
                // e.g., .../Sports18_1_HD_BTS/...
                const urlParts = streamUrl.split('/');
                for(let part of urlParts) {
                    if(STATIC_KEYS[part]) {
                        console.log("Found Static Key override for:", part);
                        drmConfig = { clearKeys: STATIC_KEYS[part] };
                    }
                }
                break; 
              }
              else if (line.startsWith('#EXTINF:')) break;
            }
            break;
          }
        }

        if (!streamUrl) { status.innerText = "Channel Not Found"; return; }

      } catch (e) { status.innerText = "Playlist Error"; return; }

      status.style.display = 'none';

      // --- 3. FORCE HD (1080p) ---
      player.configure({
        drm: drmConfig,
        abr: {
            enabled: true,
            defaultBandwidthEstimate: 25000000, // 25 Mbps = Forces Max Quality
            switchInterval: 0
        },
        streaming: {
          bufferingGoal: 60,
          rebufferingGoal: 10,
          retryParameters: { maxAttempts: 5, baseDelay: 1000, backoffFactor: 1.2 }
        }
      });

      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
        request.headers['Referer'] = 'https://www.jiotv.com/';
        if (cookieHeader) {
          request.headers['Cookie'] = cookieHeader;
          if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) && !request.uris[0].includes('hdnea=')) {
             const sep = request.uris[0].includes('?') ? '&' : '?';
             request.uris[0] += sep + cookieHeader;
          }
        }
      });

      // Worker Proxy
      if (streamUrl.startsWith('http:')) {
         streamUrl = WORKER_URL + streamUrl;
      }

      // Play
      try {
        await player.load(streamUrl);
      } catch (e) {
        console.error(e);
        status.innerText = "Playback Failed: " + e.code;
        status.style.display = 'block';
      }
    });
  </script>
</body>
</html>
