<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JioTV HD Player</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;height:100vh;width:100vw;overflow:hidden;}
.shaka-video-container{width:100%;height:100%;}
video{width:100%;height:100%;background:#000;object-fit:contain;}
.back-btn{
position:absolute;top:20px;left:20px;z-index:99;
background:rgba(0,0,0,0.5);color:white;
padding:8px 16px;border-radius:20px;text-decoration:none;
}
#status{
position:absolute;top:50%;left:50%;
transform:translate(-50%,-50%);
color:white;background:rgba(0,0,0,0.8);
padding:15px 25px;border-radius:30px;z-index:50;
}
</style>
</head>
<body>

<a href="index.html" class="back-btn">‚Üê Back</a>
<div id="status">Loading Channel...</div>

<div class="shaka-video-container" data-shaka-player>
<video autoplay playsinline></video>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {

const status = document.getElementById('status');
const params = new URLSearchParams(window.location.search);
const channelId = params.get('id');

if(!channelId){
status.innerText="Channel ID Missing";
return;
}

shaka.polyfill.installAll();
if(!shaka.Player.isBrowserSupported()){
status.innerText="Browser Not Supported";
return;
}

const video=document.querySelector('video');
const player=new shaka.Player(video);
new shaka.ui.Overlay(player,document.querySelector('.shaka-video-container'),video);

let streamUrl="";
let clearKeys={};
let cookie="";
let refreshTimer=null;
let retryCount=0;
const MAX_RETRY=5;

/* -------- FETCH STREAM DATA -------- */
async function fetchStreamData(){
const response=await fetch(
`https://pkll.xojiv79335.workers.dev/?id=${channelId}&t=${Date.now()}`
);
return await response.json();
}

/* -------- LOAD STREAM -------- */
async function loadStream(){
try{
status.style.display="block";
status.innerText="Fetching Live Stream Data...";

const data=await fetchStreamData();

streamUrl=data.mpd;
clearKeys=data.keys;
cookie=data.cookie;

if(!streamUrl||!clearKeys){
status.innerText="Invalid Stream Data";
return;
}

player.configure({
drm:{clearKeys:clearKeys},
abr:{enabled:true,defaultBandwidthEstimate:20000000},
streaming:{
lowLatencyMode:true,
bufferingGoal:45,
rebufferingGoal:10
}
});

player.getNetworkingEngine().registerRequestFilter((type,request)=>{

request.headers['User-Agent']=
"plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";

request.headers['Referer']="https://www.jiotv.com/";

if(cookie){
request.headers['Cookie']=cookie;

if(
(type===shaka.net.NetworkingEngine.RequestType.MANIFEST||
type===shaka.net.NetworkingEngine.RequestType.SEGMENT)
&&!request.uris[0].includes('hdnea=')
){
const sep=request.uris[0].includes('?')?'&':'?';
request.uris[0]+=sep+cookie;
}
}
});

await player.load(streamUrl);

status.style.display="none";
retryCount=0;

startBackgroundRefresh();

}catch(e){
handleError(e);
}
}

/* -------- AUTO RETRY -------- */
async function handleError(e){
console.log("Playback Error:",e);

if(retryCount<MAX_RETRY){
retryCount++;
status.style.display="block";
status.innerText="Reconnecting... ("+retryCount+")";

await player.unload();
await loadStream();

}else{
status.innerText="Stream Failed After Multiple Attempts";
}
}

/* -------- BACKGROUND SILENT REFRESH -------- */
function startBackgroundRefresh(){

if(refreshTimer) clearInterval(refreshTimer);

refreshTimer=setInterval(async ()=>{

try{
const data=await fetchStreamData();

if(data.cookie!==cookie){
console.log("Cookie Updated Silently");
cookie=data.cookie;
clearKeys=data.keys;
}

}catch(e){
console.log("Silent Refresh Failed");
}

},180000); // every 3 minutes
}

/* -------- PLAYER ERROR LISTENER -------- */
player.addEventListener('error',async (event)=>{
const error=event.detail;
if(error.code===6007||error.code===6010||error.code===1002){
await handleError(error);
}
});

loadStream();

});
</script>

</body>
</html>
