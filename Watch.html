<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JioTV HD Player</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  
  <style>
    /* 1. RESET & LAYOUT */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; height: 100vh; width: 100vw; overflow: hidden; font-family: 'Roboto', sans-serif; }
    .shaka-video-container { width: 100%; height: 100%; }
    video { width: 100%; height: 100%; background: #000; object-fit: contain; }
    
    /* 2. CUSTOM UI STYLING (MATCHING FRIEND'S CODE) */
    
    /* Settings Menu (White Background) */
    .shaka-overflow-menu, .shaka-settings-menu {
      background-color: white !important;
      color: black !important;
      border-radius: 8px !important;
      padding: 6px !important;
    }
    
    .shaka-overflow-menu button, .shaka-settings-menu button {
      color: black !important;
      font-weight: 500 !important;
    }
    
    .shaka-overflow-menu button:hover, .shaka-settings-menu button:hover {
      background-color: #f0f0f0 !important;
    }
    
    /* Control Bar Icons */
    .shaka-controls-button-panel .material-icons-round {
      color: white !important;
    }

    /* Seek Bar */
    .shaka-seek-bar-container { height: 6px !important; }
    
    /* Hide Default Spinner */
    .shaka-spinner-container { display: none !important; }
    
    /* 3. OVERLAYS */
    .back-btn {
      position: absolute; top: 20px; left: 20px; z-index: 99;
      background: rgba(0,0,0,0.5); color: white; padding: 8px 16px;
      border-radius: 20px; text-decoration: none; border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(4px); font-size: 14px;
    }
    
    #status {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 16px; background: rgba(0,0,0,0.8);
      padding: 15px 25px; border-radius: 30px; z-index: 50;
      backdrop-filter: blur(5px);
    }
  </style>
</head>
<body>

  <a href="index.html" class="back-btn">‚Üê Back</a>
  <div id="status">Finding Channel Stream...</div>

  <div class="shaka-video-container" data-shaka-player>
    <video autoplay playsinline preload="metadata" poster="https://ik.imagekit.io/24sfhkkep/shwe7ank-poster-16x9.png"></video>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const status = document.getElementById('status');
      
      // 1. Get Channel ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const targetId = urlParams.get('id');
      
      if (!targetId) {
        status.innerText = "Error: No Channel ID";
        return;
      }

      // 2. Initialize Shaka
      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) {
        status.innerText = "Browser Not Supported";
        return;
      }

      const video = document.querySelector('video');
      const player = new shaka.Player(video);
      const ui = new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);

      // 3. UI Configuration (Resolution Selector Enabled)
      ui.configure({
        controlPanelElements: [
          'play_pause', 'time_and_duration', 'mute', 'volume',
          'spacer', 'quality', 'fullscreen', 'overflow_menu'
        ],
        seekBarColors: {
          base: 'rgba(255, 255, 255, 0.3)',
          buffered: 'rgba(255, 255, 255, 0.54)',
          played: 'rgb(255, 69, 0)'
        }
      });

      // 4. SMART M3U PARSER
      // This part finds the SPECIFIC cookie and DRM for the ID you clicked
      let streamUrl = "";
      let cookieHeader = "";
      let drmConfig = {};

      try {
        status.innerText = "Fetching Channel Keys...";
        // Using your exact assets
        const res = await fetch('https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u');
        const text = await res.text();
        const lines = text.split('\n');
        
        let found = false;

        for (let i = 0; i < lines.length; i++) {
          // Look for the ID passed from index.html
          if (lines[i].includes(`tvg-id="${targetId}"`)) {
            found = true;
            
            // Once found, look ahead for the stream details
            for (let j = i + 1; j < lines.length; j++) {
              const line = lines[j].trim();
              
              // Extract Cookie
              if (line.startsWith('#EXTHTTP:')) {
                const cookie = line.match(/"cookie":"([^"]+)"/);
                if (cookie) cookieHeader = cookie[1];
              } 
              // Extract DRM Keys (Essential for Star Sports)
              else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                const key = line.match(/license_key=([^:]+):([^$]+)/);
                if (key) drmConfig = { clearKeys: { [key[1]]: key[2] } };
              }
              // Extract URL
              else if (line.startsWith('http')) {
                streamUrl = line;
                break; // We have the URL, stop scanning
              }
              // Stop if we hit the next channel
              else if (line.startsWith('#EXTINF:')) break; 
            }
            break;
          }
        }

        if (!found || !streamUrl) {
          status.innerText = "Channel Not Found in Playlist";
          return;
        }

      } catch (e) {
        status.innerText = "Playlist Error. Check Internet.";
        return;
      }

      status.style.display = 'none';

      // 5. PLAYER CONFIGURATION (FORCE HD & HEADERS)
      player.configure({
        drm: drmConfig,
        abr: {
            enabled: true,
            // 20 Mbps Estimate = Forces Player to grab the highest quality (1080p/720p) instantly
            defaultBandwidthEstimate: 20000000, 
            switchInterval: 0
        },
        streaming: {
          lowLatencyMode: true,
          bufferingGoal: 45,
          rebufferingGoal: 10,
          retryParameters: { maxAttempts: 5, baseDelay: 500, backoffFactor: 1.2 },
          useNativeHlsOnSafari: true
        }
      });

      // 6. REQUEST FILTER (INJECT COOKIES & HEADERS)
      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
        request.headers['Referer'] = 'https://www.jiotv.com/';
        
        if (cookieHeader) {
          request.headers['Cookie'] = cookieHeader;
          // Important: Some Jio tokens need to be in the URL too
          if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST || 
               type === shaka.net.NetworkingEngine.RequestType.SEGMENT) && 
               request.uris[0] && !request.uris[0].includes('hdnea=')) {
             const sep = request.uris[0].includes('?') ? '&' : '?';
             request.uris[0] += sep + cookieHeader;
          }
        }
      });

      // 7. WORKER PROXY (YOUR ASSET)
      // Since M3U has http links, we wrap them in your worker to play on HTTPS sites
      if (streamUrl.startsWith('http:')) {
         const WORKER_URL = "https://pkll.xojiv79335.workers.dev/";
         streamUrl = WORKER_URL + streamUrl;
      }

      // 8. LOAD & AUTOPLAY
      try {
        await player.load(streamUrl);
        // Autoplay logic
        const playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.catch(_ => {
              // Auto-play was prevented; mute and play
              video.muted = true;
              video.play();
            });
        }
      } catch (e) {
        console.error(e);
        status.innerText = "Playback Error: " + e.code;
        status.style.display = 'block';
      }
    });
  </script>
</body>
</html>
