<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JioTV Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous" />
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { background: #000; height: 100vh; width: 100vw; overflow: hidden; font-family: -apple-system, sans-serif; }
      .shaka-video-container { position: absolute; inset: 0; width: 100%; height: 100%; }
      video { width: 100%; height: 100%; background: #000; object-fit: contain; }
      
      /* Hide default Shaka Spinner (we use ours) */
      .shaka-spinner-container { display: none !important; }

      /* UI Overlay */
      .channel-info { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); padding: 20px; display: flex; align-items: center; z-index: 10; transition: opacity 0.5s; }
      .channel-info.hidden { opacity: 0; pointer-events: none; }
      .channel-logo { width: 50px; height: 50px; margin-right: 15px; border-radius: 50%; background: #fff; padding: 2px; }
      .channel-name { font-size: 1.4rem; font-weight: 600; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
      
      /* Back Button */
      .back-btn { position: absolute; top: 25px; right: 25px; background: rgba(255,255,255,0.15); color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-weight: bold; font-size: 14px; backdrop-filter: blur(5px); z-index: 20; border: 1px solid rgba(255,255,255,0.1); }

      /* Status Messages */
      .center-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center; z-index: 5; }
      .error-box { background: rgba(20,20,20,0.95); padding: 25px; border-radius: 12px; border: 1px solid #333; max-width: 85%; display: none; }
      .retry-btn { margin-top: 15px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    </style>
  </head>
  <body>
    <a href="index.html" class="back-btn">âœ• Close</a>

    <div class="channel-info" id="channelInfo">
      <img class="channel-logo" id="channelLogo" src="" onerror="this.style.display='none'" />
      <div class="channel-name" id="channelName">Loading...</div>
    </div>
    
    <div class="shaka-video-container" data-shaka-player>
      <video autoplay playsinline id="video"></video>
    </div>
    
    <div class="center-msg" id="loader">Initializing Player...</div>
    
    <div class="center-msg error-box" id="errorBox">
      <h3 style="margin-bottom:10px; color:#ef4444;">Playback Failed</h3>
      <p id="errorText" style="color:#ccc; font-size:14px;"></p>
      <button class="retry-btn" onclick="location.reload()">Try Again</button>
    </div>

    <script>
      const WORKER_URL = "https://pkll.xojiv79335.workers.dev/";
      const M3U_URL = "https://raw.githubusercontent.com/alex8875/m3u/main/jstar.m3u";

      document.addEventListener('DOMContentLoaded', async () => {
        
        function getChannelId() {
          const p = new URLSearchParams(window.location.search);
          return p.get('id');
        }

        // --- 1. THE PARSER (Strictly matches friend's logic) ---
        async function fetchChannel(targetId) {
          try {
            document.getElementById('loader').innerText = "Fetching Channel List...";
            const res = await fetch(M3U_URL);
            const text = await res.text();
            
            const lines = text.split('\n');
            let current = {};
            
            for (let line of lines) {
              line = line.trim();
              if (line.startsWith('#EXTINF:')) {
                const idMatch = line.match(/tvg-id="(\d+)"/);
                const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                const nameMatch = line.split(',')[1];
                
                if (idMatch) {
                   current = { 
                     id: idMatch[1], 
                     logo: logoMatch ? logoMatch[1] : '', 
                     name: nameMatch ? nameMatch.trim() : 'Live TV' 
                   };
                }
              } else if (line.startsWith('http')) {
                if (current.id === targetId) {
                  // --- THE FIX: WRAP URL IN WORKER HERE ---
                  // This fixes the "Black Screen" on Netlify
                  current.streamUrl = WORKER_URL + line;
                  return current;
                }
                current = {};
              }
            }
          } catch (e) { throw new Error("Playlist Load Failed"); }
          return null;
        }

        // --- 2. PLAYER INIT ---
        async function initPlayer(channel) {
          shaka.polyfill.installAll();
          if (!shaka.Player.isBrowserSupported()) {
             throw new Error("Browser Not Supported");
          }

          const video = document.getElementById('video');
          const player = new shaka.Player(video);
          const ui = new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);

          // UI Config (Matches friend)
          ui.configure({
            controlPanelElements: ['play_pause', 'time_and_duration', 'mute', 'volume', 'spacer', 'fullscreen'],
            seekBarColors: { base: 'rgba(255,255,255,0.3)', buffered: 'rgba(255,255,255,0.5)', played: '#3b82f6' }
          });

          // Network Filters (The Secret Sauce)
          player.getNetworkingEngine().registerRequestFilter((type, request) => {
            // We set the User-Agent to trick the server
            request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
            // We do NOT set Referer here because the Worker handles it.
            // Setting it here often causes CORS errors in the browser.
          });

          player.configure({
            streaming: { 
              bufferingGoal: 15,
              rebufferingGoal: 2,
              retryParameters: { maxAttempts: 5, baseDelay: 1000 } 
            }
          });

          // Error Handler
          player.addEventListener('error', (e) => {
             console.error(e);
             if (e.detail.code === 7002 || e.detail.code === 1001 || e.detail.code === 1002) {
                showError("Stream Offline or Network Blocked.<br>Try a different channel.");
             }
          });

          // Load
          document.getElementById('loader').innerText = "Connecting to Satellite...";
          console.log("Playing:", channel.streamUrl); // Debugging
          
          await player.load(channel.streamUrl);
          
          // Success
          document.getElementById('loader').style.display = 'none';
          document.getElementById('channelLogo').src = channel.logo;
          document.getElementById('channelName').innerText = channel.name;
          
          // Hide info after 4s
          setTimeout(() => document.getElementById('channelInfo').classList.add('hidden'), 4000);
        }

        // --- 3. STARTUP ---
        try {
          const id = getChannelId();
          if(!id) throw new Error("No Channel ID Provided");
          
          const channel = await fetchChannel(id);
          if(!channel) throw new Error("Channel Not Found in Playlist");
          
          await initPlayer(channel);
          
        } catch (e) {
          showError(e.message);
        }

        function showError(msg) {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('errorBox').style.display = 'block';
          document.getElementById('errorText').innerHTML = msg;
        }
      });
    </script>
  </body>
</html>
