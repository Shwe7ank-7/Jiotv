<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JioTV HD Player</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  
  <style>
    /* 1. RESET & LAYOUT */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; height: 100vh; width: 100vw; overflow: hidden; font-family: 'Roboto', sans-serif; }
    .shaka-video-container { width: 100%; height: 100%; }
    video { width: 100%; height: 100%; background: #000; }
    
    /* 2. CUSTOM UI STYLING (MATCHING SCREENSHOT) */
    
    /* The Settings Menu (White Background) */
    .shaka-overflow-menu, .shaka-settings-menu {
      background-color: white !important;
      color: black !important;
      border-radius: 8px !important;
      padding: 10px !important;
    }
    
    /* Menu Buttons */
    .shaka-overflow-menu button, .shaka-settings-menu button {
      color: black !important;
      font-weight: 500 !important;
      font-size: 14px !important;
    }
    
    /* Hover Effects */
    .shaka-overflow-menu button:hover, .shaka-settings-menu button:hover {
      background-color: #f0f0f0 !important;
    }
    
    /* Checkmark / Icons */
    .shaka-current-selection-span {
      color: #000 !important;
      font-weight: bold;
    }
    
    /* The Icons in the Control Bar (Keep White) */
    .shaka-controls-button-panel .material-icons-round {
      color: white !important;
    }

    /* Seek Bar Colors */
    .shaka-seek-bar-container { height: 6px !important; }
    
    /* Hide Default Spinner */
    .shaka-spinner-container { display: none !important; }
    
    /* 3. CUSTOM OVERLAYS */
    .back-btn {
      position: absolute; top: 20px; left: 20px; z-index: 99;
      background: rgba(0,0,0,0.4); color: white; padding: 8px 16px;
      border-radius: 20px; text-decoration: none; border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(4px); font-size: 14px;
    }
    
    #status {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 16px; background: rgba(0,0,0,0.7);
      padding: 15px 25px; border-radius: 30px; z-index: 50;
      backdrop-filter: blur(5px);
    }
  </style>
</head>
<body>

  <a href="index.html" class="back-btn">‚Üê Back</a>
  <div id="status">Loading HD Stream...</div>

  <div class="shaka-video-container" data-shaka-player>
    <video autoplay playsinline preload="metadata" poster="https://webiptv.site/weiptv.webp"></video>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const status = document.getElementById('status');
      
      // 1. Get Channel ID
      const urlParams = new URLSearchParams(window.location.search);
      const targetId = urlParams.get('id');
      
      if (!targetId) {
        status.innerText = "Error: No Channel ID";
        return;
      }

      // 2. Initialize Shaka
      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) {
        status.innerText = "Browser Not Supported";
        return;
      }

      const video = document.querySelector('video');
      const player = new shaka.Player(video);
      const ui = new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);

      // 3. UI Configuration (Resolution, etc)
      ui.configure({
        controlPanelElements: [
          'play_pause', 'time_and_duration', 'spacer', 
          'quality', // THIS ENABLES THE RESOLUTION SELECTOR
          'fullscreen', 'overflow_menu'
        ],
        seekBarColors: {
          base: 'rgba(255, 255, 255, 0.3)',
          buffered: 'rgba(255, 255, 255, 0.54)',
          played: '#FF0000' // Red like YouTube/Jio
        }
      });

      // 4. FIND CHANNEL DATA IN M3U
      let streamUrl = "";
      let cookieHeader = "";
      let drmConfig = {};

      try {
        const res = await fetch('https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u');
        const text = await res.text();
        const lines = text.split('\n');
        
        let found = false;

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes(`tvg-id="${targetId}"`)) {
            found = true;
            // Scan forward for props
            for (let j = i + 1; j < lines.length; j++) {
              const line = lines[j].trim();
              
              if (line.startsWith('#EXTHTTP:')) {
                const cookie = line.match(/"cookie":"([^"]+)"/);
                if (cookie) cookieHeader = cookie[1];
              } 
              else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                const key = line.match(/license_key=([^:]+):([^$]+)/);
                if (key) drmConfig = { clearKeys: { [key[1]]: key[2] } };
              }
              else if (line.startsWith('http')) {
                streamUrl = line;
                break; // URL found
              }
              else if (line.startsWith('#EXTINF:')) break; // Stop if we hit next channel
            }
            break;
          }
        }

        if (!found || !streamUrl) {
          status.innerText = "Channel Offline or Not Found";
          return;
        }

      } catch (e) {
        status.innerText = "Playlist Error";
        return;
      }

      status.style.display = 'none';

      // 5. PLAYER CONFIGURATION (FORCE HD)
      player.configure({
        drm: drmConfig,
        abr: {
            enabled: true,
            // 20 Mbps Estimate = Forces Player to choose 1080p/720p immediately
            defaultBandwidthEstimate: 20000000, 
            switchInterval: 0
        },
        streaming: {
          lowLatencyMode: true,
          bufferingGoal: 60, // Large buffer for stable HD
          rebufferingGoal: 5,
          retryParameters: { maxAttempts: 5, baseDelay: 500, backoffFactor: 1.2 },
          useNativeHlsOnSafari: true
        }
      });

      // 6. HEADERS & PROXY
      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
        request.headers['Referer'] = 'https://www.jiotv.com/';
        
        if (cookieHeader) {
          request.headers['Cookie'] = cookieHeader;
          // Append cookie to URL for strict token checking
          if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST || 
               type === shaka.net.NetworkingEngine.RequestType.SEGMENT) && 
               request.uris[0] && !request.uris[0].includes('hdnea=')) {
             const sep = request.uris[0].includes('?') ? '&' : '?';
             request.uris[0] += sep + cookieHeader;
          }
        }
      });

      // Worker Proxy for HTTPS fixes
      if (streamUrl.startsWith('http:')) {
         const WORKER_URL = "https://pkll.xojiv79335.workers.dev/";
         streamUrl = WORKER_URL + streamUrl;
      }

      // 7. LOAD & AUTOPLAY
      try {
        await player.load(streamUrl);
        video.muted = false;
        video.play().catch(() => {
           video.muted = true;
           video.play();
        });
      } catch (e) {
        console.error(e);
        status.innerText = "Playback Error: " + e.code;
        status.style.display = 'block';
      }
    });
  </script>
</body>
</html>
