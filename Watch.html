<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JioTV Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous" />
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: #000; height: 100vh; width: 100vw; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
    .shaka-video-container { position: absolute; inset: 0; width: 100%; height: 100%; }
    video { width: 100%; height: 100%; background: #000; object-fit: contain; }
    .shaka-spinner-container, .shaka-spinner, .shaka-spinner-svg { display: none !important; visibility: hidden !important; opacity: 0 !important; }
    .channel-info { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%); padding: 1rem; display: flex; align-items: center; z-index: 10; transition: opacity 0.3s ease; }
    .channel-info.hidden { opacity: 0; pointer-events: none; }
    .channel-logo { width: 40px; height: 40px; margin-right: 15px; border-radius: 8px; background: #222; }
    .channel-name { font-size: 1.2rem; font-weight: 500; color: white; }
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.2rem; text-align: center; z-index: 5; }
    .error { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 1.2rem; text-align: center; background: rgba(0, 0, 0, 0.7); padding: 2rem; border-radius: 8px; max-width: 80%; }
    .error.hidden { display: none; }
    /* Added Back Button for usability */
    .back-btn { position: absolute; top: 20px; right: 20px; z-index: 100; color: white; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 5px; text-decoration: none; border: 1px solid #555; }
    </style>
  </head>
  <body>
    <a href="index.html" class="back-btn">Back</a>
    <div class="channel-info hidden" id="channelInfo">
      <img class="channel-logo" id="channelLogo" src="" alt="Channel Logo" onerror="this.style.display='none'" />
      <div class="channel-name" id="channelName">Loading Channel...</div>
    </div>
    <div class="shaka-video-container" data-shaka-player="">
      <video autoplay="" playsinline="" preload="metadata" poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MDAiIHZpZXdCb3g9IjAgMCAxMjAwIDYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMjIyIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkppb1RWIFBsYXllcjwvdGV4dD48L3N2Zz4="></video>
    </div>
    <div class="loading" id="loadingMessage">Loading player and channel data...</div>
    <div class="error hidden" id="errorMessage">
      <h2>Error Loading Channel</h2>
      <p id="errorText"></p>
    </div>
    <script>
      // YOUR WORKER URL (Needed to fix Mixed Content Error)
      const WORKER_PREFIX = "https://pkll.xojiv79335.workers.dev/";

      document.addEventListener('DOMContentLoaded', async () => {
      function getChannelIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
      }
      
      function showError(message) {
        const errorText = document.getElementById('errorText');
        const errorMessage = document.getElementById('errorMessage');
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
        loadingMessage.style.display = 'none';
        console.error('Error:', message);
      }
      
      function hideChannelInfo() {
        setTimeout(() => { channelInfo.classList.add('hidden'); }, 5000);
      }
      
      function findChannelInM3U(content, targetId) {
        const lines = content.split('\n');
        let currentChannel = {};
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          
          if (line.startsWith('#EXTINF:')) {
            const infoMatch = line.match(/#EXTINF:.*?tvg-id="(\d+)".*?tvg-logo="([^"]+)".*?,(.*)$/);
            if (infoMatch) {
              currentChannel = {
                id: infoMatch[1],
                logo: infoMatch[2],
                name: infoMatch[3].trim(),
                licenseKey: '',
                cookie: '',
                streamUrl: ''
              };
            }
          } else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
            const keyMatch = line.match(/license_key=([^:\s]+):([^\s]+)/);
            if (keyMatch) { currentChannel.licenseKey = `${keyMatch[1]}:${keyMatch[2]}`; }
          } else if (line.startsWith('#EXTHTTP:')) {
            try {
              const jsonMatch = line.match(/#EXTHTTP:\s*(\{.*\})/);
              if (jsonMatch) {
                const data = JSON.parse(jsonMatch[1]);
                if (data.cookie) { currentChannel.cookie = data.cookie; }
              }
            } catch (e) { console.error('Error parsing cookie JSON:', e); }
          } else if (line.startsWith('http')) {
            // ONLY CHANGE: Prefix with your worker so it plays in the browser
            currentChannel.streamUrl = WORKER_PREFIX + line;
            
            if (currentChannel.id === targetId) { return currentChannel; }
            currentChannel = {};
          }
        }
        return null;
      }
      
      async function fetchChannel() {
        const channelId = getChannelIdFromUrl();
        if (!channelId) { showError('No channel ID specified. URL needs ?id=NUMBER'); return null; }
        
        try {
          loadingMessage.textContent = `Loading channel ${channelId}...`;
          // Fetching the exact list your friend uses
          const response = await fetch('https://raw.githubusercontent.com/alex8875/m3u/main/jstar.m3u');
          if (!response.ok) throw new Error(`Failed to fetch M3U8: ${response.status}`);
          
          const content = await response.text();
          const channel = findChannelInM3U(content, channelId);
          if (!channel) throw new Error(`Channel ID ${channelId} not found`);
          
          return channel;
        } catch (error) { showError('Error loading channel: ' + error.message); return null; }
      }

      async function initPlayerWithChannel(channel) {
        shaka.polyfill.installAll();
        if (!shaka.Player.isBrowserSupported()) { showError('Browser not supported'); return; }

        const video = document.querySelector('video');
        const player = new shaka.Player();
        await player.attach(video);

        const container = document.querySelector('.shaka-video-container');
        const ui = new shaka.ui.Overlay(player, container, video);
        
        // Use friend's UI config
        ui.configure({
          controlPanelElements: ['play_pause', 'time_and_duration', 'mute', 'volume', 'spacer', 'language', 'captions', 'picture_in_picture', 'quality', 'fullscreen'],
          volumeBarColors: { base: 'rgba(63, 187, 1, 1)', level: 'rgb(255, 69, 0)' },
          seekBarColors: { base: 'rgb(41, 41, 163)', buffered: 'rgb(35, 99, 3)', played: 'rgba(63, 187, 1, 1)' }
        });

        // Config DRM if keys exist
        if (channel.licenseKey) {
            const [keyId, keyValue] = channel.licenseKey.split(':');
            player.configure({ drm: { clearKeys: { [keyId]: keyValue } } });
        }

        let cookieHeader = channel.cookie;
        player.getNetworkingEngine().registerRequestFilter((type, request) => {
          request.headers['Referer'] = 'https://www.jiotv.com/';
          request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
          if (cookieHeader) {
            request.headers['Cookie'] = cookieHeader;
            if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) && request.uris[0] && !request.uris[0].includes('__hdnea__=')) {
              const separator = request.uris[0].includes('?') ? '&' : '?';
              request.uris[0] += separator + cookieHeader;
            }
          }
        });

        const enableAutoplay = () => { video.setAttribute('autoplay', ''); video.setAttribute('playsinline', ''); video.autoplay = true; };
        const attemptAutoplay = async () => {
          try { video.muted = false; await video.play(); return true; } 
          catch (error) {
            try { video.muted = true; await video.play(); return true; } catch (e) { return false; }
          }
        };

        try {
          enableAutoplay();
          await player.load(channel.streamUrl);
          if (video.readyState >= 3) await attemptAutoplay();
          else { video.addEventListener('canplay', attemptAutoplay, { once: true }); setTimeout(async () => { if (video.paused) await attemptAutoplay(); }, 2000); }
        } catch (error) { console.error('Load error:', error); }

        const channelInfo = document.getElementById('channelInfo');
        document.getElementById('channelLogo').src = channel.logo;
        document.getElementById('channelName').textContent = channel.name;
        channelInfo.classList.remove('hidden');
        hideChannelInfo();
        loadingMessage.style.display = 'none';
      }

      const channel = await fetchChannel();
      if (channel) { await initPlayerWithChannel(channel); }
    });

      if (confirm("Join Our Telegram Channel @Axtream_Bingewav for updates")) {
          window.location.href = "https://t.me/axtream_bingewav";
      }
    </script>
  </body>
</html>
