<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0"></script>
<style>
  body { margin: 0; background: #000; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: sans-serif; }
  
  #video-container {
    flex: 1;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  video { width: 100%; height: 100%; object-fit: contain; }

  /* Controls Overlay */
  .overlay {
    position: absolute; top: 0; left: 0; width: 100%; padding: 20px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
    z-index: 10; display: flex; align-items: center; gap: 15px;
  }

  .back-btn {
    background: rgba(255,255,255,0.1); color: white;
    text-decoration: none; padding: 8px 16px; border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.2); font-size: 14px;
    backdrop-filter: blur(5px);
  }

  /* Status Box */
  #status-box {
    position: absolute;
    background: rgba(20, 20, 20, 0.9);
    border: 1px solid #333;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    color: #fff;
    max-width: 90%;
    display: none; /* Hidden by default */
  }
  
  .error-code { color: #ef4444; font-weight: bold; margin-bottom: 10px; display: block; }
  .retry-btn {
    background: #3b82f6; color: white; border: none;
    padding: 10px 20px; border-radius: 5px; cursor: pointer;
    margin-top: 15px; font-weight: bold;
  }
</style>
</head>
<body>

<div class="overlay">
  <a href="index.html" class="back-btn">‚Üê Back to Channels</a>
  <span style="color:#aaa; font-size:12px;">Live Stream</span>
</div>

<div id="video-container">
  <div id="status-box">
    <span class="error-code" id="error-msg">Connecting...</span>
    <div id="debug-info" style="font-size:11px; color:#888; margin-bottom:10px;"></div>
    <div class="loader"></div>
    <button class="retry-btn" onclick="location.reload()">Retry Connection</button>
  </div>
  <video id="video" controls autoplay playsinline></video>
</div>

<script>
// --- CONFIGURATION ---
const WORKER = "https://pkll.xojiv79335.workers.dev/"; 

const video = document.getElementById('video');
const statusBox = document.getElementById('status-box');
const errorMsg = document.getElementById('error-msg');
const debugInfo = document.getElementById('debug-info');

// Get params
const urlParams = new URLSearchParams(window.location.search);
const rawStreamUrl = urlParams.get('play');

if (!rawStreamUrl) {
  showError("No Channel Selected", "Please go back and click a channel.");
} else {
  startPlayer();
}

function startPlayer() {
  // 1. Construct the Safe URL
  // We FORCE the worker because browsers block mixed content (HTTP vs HTTPS)
  // If the stream is http://, it MUST go through the https:// worker.
  
  let finalUrl = rawStreamUrl;
  
  // Logic: Append URL to worker if not already there
  if (!rawStreamUrl.includes(WORKER)) {
     // Some workers need ?url=, some just append. We try the safest query param method first.
     // If your worker is a direct proxy, it might need just the URL appended.
     // Let's try the direct append method first as it's common for 'pkll' scripts.
     finalUrl = WORKER + rawStreamUrl;
  }

  console.log("Target:", finalUrl);

  if (Hls.isSupported()) {
    const hls = new Hls({
      debug: false,
      enableWorker: true,
      lowLatencyMode: true,
      backBufferLength: 90
    });

    hls.loadSource(finalUrl);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      hideError();
      video.play().catch(() => {
        showError("Autoplay Blocked", "Tap the screen to unmute/play.");
      });
    });

    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        console.error("Fatal Error:", data);
        if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
          showError("Network Error", "The worker could not fetch this stream. <br>The channel might be offline.");
          debugInfo.innerText = "Try clicking 'Retry' or select another channel.";
        } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
          hls.recoverMediaError();
        } else {
          showError("Playback Failed", "Code: " + data.details);
        }
      }
    });

  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    // iOS / Safari
    video.src = finalUrl;
    video.addEventListener('loadedmetadata', () => video.play());
    video.addEventListener('error', (e) => {
        showError("iOS Error", "Safari could not load this stream.");
    });
  }
}

function showError(title, desc) {
  statusBox.style.display = 'block';
  errorMsg.innerText = title;
  debugInfo.innerHTML = desc;
  video.style.opacity = 0.3; // Dim video
}

function hideError() {
  statusBox.style.display = 'none';
  video.style.opacity = 1;
}
</script>
</body>
  </html>
  
